name: CI Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    env:
      OPENSSL_PATH: "C:\\Program Files\\OpenSSL\\bin"

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install MSVC
      run: |
        choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64"

    - name: Install OpenSSL
      run: |
        choco install openssl
        echo "OPENSSL_PATH=${OPENSSL_PATH}" >> $GITHUB_ENV

    - name: Install OpenCV dependencies
      run: |
        choco install opencv

    - name: Add OpenSSL to PATH
      run: |
        $newPath = "${env:OPENSSL_PATH};${env:Path}"
        [Environment]::SetEnvironmentVariable("Path", $newPath, "Machine")

    - name: Set up MSBuild environment
      run: |
        "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
        $env:Path += ";C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin"

    - name: Build HMACtask
      run: |
        msbuild HMACtask/HMACtask.sln /p:Configuration=Debug

    - name: Test HMACtask
      run: |
        cd HMACtask
        ./Debug/HMACtask.exe  # Assuming Debug configuration
